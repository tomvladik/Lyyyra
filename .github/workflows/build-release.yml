name: Build and Package

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  GO_VERSION_FILE: go.mod
  WAILS_VERSION: v2.11.0
  GOLANGCI_LINT_VERSION: v1.64.8

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Build frontend (compile TypeScript)
        run: npm run build
        working-directory: frontend

      - name: Lint frontend
        run: npm run lint
        working-directory: frontend

      - name: Run frontend tests with coverage
        run: |
          npm run test:coverage -- --run --reporter=verbose --reporter=json --outputFile=test-results.json
        working-directory: frontend

      - name: Generate frontend test summary
        if: always()
        run: |
          echo "## ðŸ§ª Frontend Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f frontend/test-results.json ]; then
            node -e "
            const fs = require('fs');
            try {
              const results = JSON.parse(fs.readFileSync('frontend/test-results.json', 'utf8'));
              const total = results.numTotalTests || 0;
              const passed = results.numPassedTests || 0;
              const failed = results.numFailedTests || 0;
              const skipped = results.numPendingTests || 0;
              console.log('| Status | Count |');
              console.log('|--------|-------|');
              console.log('| âœ… Passed | ' + passed + ' |');
              console.log('| âŒ Failed | ' + failed + ' |');
              console.log('| â­ï¸ Skipped | ' + skipped + ' |');
              console.log('| **ðŸ“Š Total** | **' + total + '** |');
              console.log('');
              const runtime = results.testResults?.[0]?.perfStats?.runtime || 0;
              console.log('â±ï¸ Duration: ' + (runtime / 1000).toFixed(2) + 's');
            } catch (e) {
              console.log('âš ï¸ Error parsing test results: ' + e.message);
            }
            " >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Test results file not found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate frontend coverage summary
        if: always()
        run: |
          echo "## ðŸ“Š Frontend Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f frontend/coverage/coverage-summary.json ]; then
            node -e "
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('frontend/coverage/coverage-summary.json', 'utf8'));
            const total = coverage.total;
            console.log('| Metric | Coverage |');
            console.log('|--------|----------|');
            console.log('| Statements | ' + total.statements.pct + '% |');
            console.log('| Branches | ' + total.branches.pct + '% |');
            console.log('| Functions | ' + total.functions.pct + '% |');
            console.log('| Lines | ' + total.lines.pct + '% |');
            " >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š **[ðŸ“ˆ View Interactive Coverage Report on GitHub Pages](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)** (available after deployment)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ [Download artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)" >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload frontend coverage
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('frontend/coverage/**') != ''
        with:
          name: frontend-coverage
          path: |
            frontend/coverage
            frontend/test-results.json
          retention-days: 30

      - name: Upload frontend dist
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 1

      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@${{ env.GOLANGCI_LINT_VERSION }}

      - name: Lint Go code
        run: golangci-lint run ./internal/... -v

      - name: Run Go tests with coverage
        run: |
          go install gotest.tools/gotestsum@v1.11.0
          gotestsum --format testname --junitfile go-test-results.xml -- -coverprofile=coverage.out ./internal/...
          go tool cover -func=coverage.out | tee coverage.txt
          go tool cover -html=coverage.out -o coverage.html

      - name: Generate Go test summary
        if: always()
        run: |
          echo "## ðŸ§ª Go Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f go-test-results.xml ]; then
            # Parse test results with defaults
            total=$(grep -o 'tests="[0-9]*"' go-test-results.xml 2>/dev/null | head -1 | grep -o '[0-9]*' || echo "0")
            failures=$(grep -o 'failures="[0-9]*"' go-test-results.xml 2>/dev/null | head -1 | grep -o '[0-9]*' || echo "0")
            skipped=$(grep -o 'skipped="[0-9]*"' go-test-results.xml 2>/dev/null | head -1 | grep -o '[0-9]*' || echo "0")
            passed=$((total - failures - skipped))
            
            echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $passed |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $failures |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $skipped |" >> $GITHUB_STEP_SUMMARY
            echo "| **ðŸ“Š Total** | **$total** |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Test results file not found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate Go coverage summary
        if: always()
        run: |
          echo "## ðŸ”§ Go Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -1 coverage.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "ðŸ“Š **[ðŸ“ˆ View Interactive Coverage Report on GitHub Pages](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)** (available after deployment)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ [Download artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)" >> $GITHUB_STEP_SUMMARY

      - name: Upload Go coverage
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('coverage.out') != ''
        with:
          name: go-coverage
          path: |
            coverage.out
            coverage.html
            go-test-results.xml
          retention-days: 30

      - name: Publish Go test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: |
          always() &&
          hashFiles('go-test-results.xml') != '' &&
          (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
        with:
          files: go-test-results.xml
          check_name: Go Test Results
          comment_mode: off

      - name: Prepare coverage reports for Pages
        if: always() && (hashFiles('coverage.html') != '' || hashFiles('frontend/coverage/index.html') != '')
        run: |
          mkdir -p coverage-reports
          if [ -f coverage.html ]; then
            cp coverage.html coverage-reports/go-coverage.html
          fi
          if [ -f frontend/coverage/index.html ]; then
            cp -r frontend/coverage coverage-reports/frontend
          fi
          cat > coverage-reports/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Coverage Reports - Lyyyra</title>
            <style>
              body { font-family: system-ui; max-width: 800px; margin: 50px auto; padding: 20px; }
              h1 { color: #333; }
              .card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 20px 0; }
              .card h2 { margin-top: 0; }
              a { color: #0366d6; text-decoration: none; }
              a:hover { text-decoration: underline; }
              .meta { color: #666; font-size: 0.9em; }
            </style>
          </head>
          <body>
            <h1>ðŸ“Š Test Coverage Reports</h1>
            <p class="meta">Build: ${{ github.run_number }} | Commit: ${{ github.sha }}</p>
            
            <div class="card">
              <h2>ðŸ”§ Go Backend Coverage</h2>
              <p><a href="go-coverage.html">View Go Coverage Report â†’</a></p>
            </div>
            
            <div class="card">
              <h2>ðŸ“Š Frontend Coverage</h2>
              <p><a href="frontend/index.html">View Frontend Coverage Report â†’</a></p>
            </div>
          </body>
          </html>
          EOF

      - name: Upload coverage reports to Pages
        if: always() && hashFiles('coverage-reports/**') != ''
        uses: actions/upload-pages-artifact@v3
        with:
          path: coverage-reports

  deploy-coverage:
    name: Deploy Coverage to Pages
    needs: test
    if: always() && github.event_name != 'pull_request'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  build-windows:
    name: Build Windows (Native MSVC)
    runs-on: windows-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Build frontend
        run: npm run build
        working-directory: frontend

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}

      - name: Build Windows application
        env:
          GO_PROD_TAGS: webkit2_41
          CGO_ENABLED: 1
          GOOS: windows
          GOARCH: amd64
        run: |
          $VERSION = if ("${{ github.ref_name }}" -match '^v') { "${{ github.ref_name }}" } else { "dev" }
          wails build -platform windows/amd64 -tags "${{ env.GO_PROD_TAGS }}" -ldflags "-X lyyyra/internal/app.buildVersion=$VERSION"

      - name: Package Windows artifact
        id: package_win
        shell: pwsh
        run: |
          $filename = "Lyyyra-windows-amd64-${{ github.ref_name }}.zip"
          Compress-Archive -Path build/bin/Lyyyra.exe -DestinationPath $filename
          echo "artifact-name=Lyyyra-windows-amd64-${{ github.ref_name }}" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "filename=$filename" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package_win.outputs.artifact-name }}
          path: ${{ steps.package_win.outputs.filename }}

  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.runner }}
    needs: test
    strategy:
      matrix:
        include:
          - platform: Linux
            runner: ubuntu-latest
            build_platform: linux/amd64
            binary_name: Lyyyra
            cc: gcc
            cxx: g++
          - platform: macOS
            runner: macos-latest
            build_platform: darwin/universal
            binary_name: Lyyyra.app
            cc: clang
            cxx: clang++
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Download frontend dist
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Install Linux dependencies
        if: matrix.platform == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}

      - name: Build application
        env:
          GO_PROD_TAGS: webkit2_41
          CGO_ENABLED: 1
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: |
          VERSION="${GITHUB_REF_NAME:-dev}"
          wails build -platform ${{ matrix.build_platform }} -tags "$GO_PROD_TAGS" -ldflags "-X lyyyra/internal/app.buildVersion=$VERSION"

      - name: Package Linux artifact
        if: matrix.platform == 'Linux'
        id: package_linux
        run: |
          platform="$(echo '${{ matrix.build_platform }}' | tr '/' '-')"
          filename="Lyyyra-${platform}-${{ github.ref_name }}.tar.gz"
          tar -c -C build/bin ${{ matrix.binary_name }} | gzip -9 > "$filename"
          echo "artifact-name=Lyyyra-${platform}-${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          echo "filename=$filename" >> "$GITHUB_OUTPUT"

      - name: Package macOS artifact
        if: matrix.platform == 'macOS'
        id: package_macos
        run: |
          platform="$(echo '${{ matrix.build_platform }}' | tr '/' '-')"
          filename="Lyyyra-${platform}-${{ github.ref_name }}.zip"
          cd build/bin && ditto -c -k --sequesterRsrc --keepParent "${{ matrix.binary_name }}" "$filename" && mv "$filename" ../..
          echo "artifact-name=Lyyyra-${platform}-${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          echo "filename=$filename" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package_linux.outputs.artifact-name || steps.package_macos.outputs.artifact-name }}
          path: ${{ steps.package_linux.outputs.filename || steps.package_macos.outputs.filename }}

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build, build-windows]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: Lyyyra-*

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          draft: false
          prerelease: false
          generate_release_notes: true
